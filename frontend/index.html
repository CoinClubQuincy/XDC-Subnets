<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Siftr Invoice → MetaMask</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <style>
    :root {
      --bg: #0f1115;
      --card: #161a22;
      --text: #e8eefc;
      --muted: #9fb0d6;
      --accent: #7aa2ff;
      --danger: #ff6b6b;
      --success: #37d99e;
      --border: #262b36;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 70% -20%, #1b2030 0%, var(--bg) 55%);
      color: var(--text);
      font: 15px/1.4 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: grid;
      place-items: center;
      min-height: 100dvh;
      padding: 24px;
    }
    .wrap {
      width: 100%;
      max-width: 680px;
    }
    .card {
      background: linear-gradient(180deg, #1a1f2a 0%, var(--card) 100%);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    h1, h2 { margin: 0 0 10px; }
    h1 { font-size: 22px; }
    h2 { font-size: 18px; color: var(--muted); }
    label { display:block; margin: 12px 0 6px; color: var(--muted); font-size: 13px;}
    input, select {
      width: 100%;
      background: #0e1118;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 11px 12px;
      outline: none;
    }
    input[readonly] { opacity: 0.8; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btns { display:flex; gap:12px; margin-top: 18px; }
    button {
      appearance:none;
      border:1px solid var(--border);
      background: linear-gradient(180deg, #27304a 0%, #20273a 100%);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 600;
    }
    button.primary {
      border-color: #2a3a7a;
      background: linear-gradient(180deg, #324cb3 0%, #2a43a1 100%);
    }
    button:disabled { opacity: .6; cursor:not-allowed; }
    .meta { margin-top: 12px; color: var(--muted); font-size: 13px; }
    .notice { margin-top: 10px; padding:10px 12px; border-radius: 10px; border:1px solid var(--border); }
    .notice.ok { border-color:#204d3b; background: #0d1d18; color:#8feac0; }
    .notice.bad { border-color:#5a1f26; background:#1a0e10; color:#ff9aa6; }
    .kbd { background:#101420; border:1px solid #293047; padding: 1px 6px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .divider { height:1px; background: var(--border); margin:16px 0; }
    .muted { color: var(--muted); }
    .txlink a { color: var(--accent); text-decoration: none; }
    .hidden { display: none; }

    /* Drawer for invoice/details */
    .drawer {
      position: fixed;
      top: 0; right: 0; bottom: 0;
      width: min(560px, 100%);
      background: transparent;
      transform: translateX(100%);
      transition: transform .28s ease;
      z-index: 30;
      display: grid;
      align-items: start;
      padding: 24px;
    }
    .drawer.open { transform: translateX(0); }
    .drawer .panel { box-shadow: 0 10px 30px rgba(0,0,0,.45); }

    /* Dim the page when drawer is open */
    .backdrop {
      position: fixed; inset: 0;
      background: rgba(5, 8, 15, 0.55);
      backdrop-filter: blur(2px);
      opacity: 0; pointer-events: none;
      transition: opacity .28s ease;
      z-index: 20;
    }
    .backdrop.show { opacity: 1; pointer-events: auto; }

    /* List styles */
    .list { list-style: none; padding: 0; margin: 0; }
    .list li { display: flex; justify-content: space-between; align-items: center; }
    .rowline {
      display: grid; grid-template-columns: 1fr auto; gap: 10px;
      padding: 12px 10px; border: 1px solid var(--border); border-radius: 12px;
      background: linear-gradient(180deg, #171c27 0%, #121722 100%);
      margin-bottom: 10px;
    }
    .rowline .left { display:flex; gap:10px; align-items:center; }
    .pill { padding: 2px 8px; border:1px solid var(--border); border-radius: 999px; font-size: 12px; color: var(--muted); }
    .small { font-size: 12px; color: var(--muted); }
    .clicky { cursor: pointer; }
    .logo { width: 24px; height: 24px; border-radius: 6px; border:1px solid var(--border); background:#0e1118; object-fit: cover; }
    .logo.lg { width: 32px; height: 32px; }
    .fiatline { margin-top: 6px; font-size: 12px; color: var(--muted); }

    /* Top status bar */
    .topbar {
      position: fixed; top: 0; left: 0; right: 0;
      height: 46px;
      background: #0d1118cc;
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      z-index: 50;
    }
    .topbar .inner {
      width: 100%; max-width: 980px; padding: 0 14px;
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px;
    }
    .brand {
      display: flex; align-items: center; gap: 10px;
      color: var(--text); font-weight: 700;
    }
    .brand .logo { width: 22px; height: 22px; border-radius: 6px; }
    .top-actions { display:flex; align-items:center; gap:10px; }
    .chip {
      font-size: 12px; padding: 4px 8px; border-radius: 999px;
      border: 1px solid var(--border); color: var(--muted);
    }
    .top-btn {
      appearance:none; border:1px solid var(--border);
      background: linear-gradient(180deg, #27304a 0%, #20273a 100%);
      color: var(--text); padding: 6px 10px; border-radius: 10px; font-weight:600;
      cursor: pointer;
    }
    .top-btn.primary {
      border-color: #2a3a7a;
      background: linear-gradient(180deg, #324cb3 0%, #2a43a1 100%);
    }
    /* Tabs for Unpaid/Paid */
    .tabs { display:flex; gap:8px; margin: 10px 0 14px; }
    .tab {
      padding: 6px 10px; border-radius: 999px; border:1px solid var(--border);
      background:#141925; color: var(--muted); cursor:pointer; font-weight:600; font-size:13px;
    }
    .tab.active { color: white; border-color:#2a3a7a; background:#1a2445; }
    body.with-topbar { padding-top: 60px; }
  </style>
</head>
<body class="with-topbar">
  <div class="topbar" id="topbar">
    <div class="inner">
      <div class="brand">
        <img class="logo" src="sifter-logo.png" alt="SFTR" />
        <span>Siftr Invoice Credit</span>
      </div>
      <div class="top-actions">
        <span id="top-balance" class="chip">Balance: —</span>
        <span id="top-address" class="chip">Account: —</span>
        <button id="top-connect" class="top-btn primary">Connect Account</button>
      </div>
    </div>
  </div>
  <div class="wrap">
    <!-- Invoices List -->
    <section id="page-list" class="card">
      <h1>Invoices</h1>
      <h2>Select an invoice to pay</h2>
      <div class="tabs">
        <div id="tab-unpaid" class="tab active">Unpaid</div>
        <div id="tab-paid" class="tab">Paid</div>
      </div>
      <ul id="invoice-list" class="list"></ul>
      <div id="no-items" class="small muted" style="display:none; margin-top:6px;">No items to display.</div>
      <div class="meta">This is a demo list with fixed amounts & IDs. Selecting one opens the invoice drawer.</div>
    </section>
    <div id="drawer-backdrop" class="backdrop hidden"></div>
    <div id="drawer" class="drawer">
      <div class="panel card">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:8px;">
          <div class="muted">Invoice Details</div>
          <button id="btn-close" title="Close" aria-label="Close">✕</button>
        </div>
    <!-- Invoice Page -->
    <section id="page-invoice">
      <h1 style="display:flex; align-items:center; gap:10px;">
        <img class="logo lg" src="sifter-logo.png" alt="SFTR" />
        Invoice
      </h1>
      <h2>Pay with SFTR via MetaMask</h2>
      <div id="chosen-invoice" class="small" style="margin-bottom:8px;"></div>

      <div class="row">
        <div>
          <label>Amount</label>
          <input id="amount" type="text" inputmode="decimal" placeholder="e.g. 12.50" />
        </div>
        <div>
          <label>Currency (symbol)</label>
          <input id="symbol" type="text" value="SFTR" />
        </div>
      </div>
      <div id="fiatSummary" class="fiatline"></div>

      <label>Invoice ID (optional)</label>
      <input id="invoiceId" type="text" placeholder="e.g. INV-2025-0001" />

      <div class="divider"></div>

      <div class="row">
        <div>
          <label>Payer Wallet</label>
          <input id="account" type="text" readonly placeholder="Not connected" />
        </div>
      </div>

      <div class="btns">
        <button id="btn-connect">Connect MetaMask</button>
        <button id="btn-pay" class="primary" disabled>Pay Invoice</button>
      </div>

      <div id="status" class="meta"></div>
      <div id="alert" class="notice hidden"></div>
    </section>

    <!-- Confirm Page -->
    <section id="page-confirm" class="hidden">
      <h1>Confirm Payment</h1>
      <div id="confirm-body" class="meta"></div>
      <div class="btns">
        <button id="btn-cancel">Back</button>
        <button id="btn-confirm" class="primary">Confirm &amp; Sign</button>
      </div>
      <div id="confirm-status" class="meta"></div>
    </section>
    <!-- Result Page -->
    <section id="page-result" class="hidden">
      <h1 id="result-title">Payment Result</h1>
      <div id="result-body" class="meta"></div>
      <div class="txlink meta" id="txlink"></div>
      <div class="btns">
        <button id="btn-back">Back to Invoice</button>
      </div>
    </section>
      </div>
    </div>
  </div>

  <!-- Ethers.js (v5) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" integrity="sha256-pmKTpqK7Te4GGmhhK+C+PFwKt+QGirjZiko1e69mTHM=" crossorigin="anonymous"></script>
  <script>
    // ============
    // CONFIG—EDIT THESE
    // ============
    // Demo invoice data (fixed for now)
    const DEMO_INVOICES = [
      { id: "INV-2025-0001", amount: "12.50", symbol: "SFTR" },
      { id: "INV-2025-0002", amount: "49.99", symbol: "SFTR" },
      { id: "INV-2025-0003", amount: "5.00",   symbol: "SFTR" },
      { id: "INV-2025-0004", amount: "199.00", symbol: "SFTR" },
    ];
    const PAID_INVOICES = [];
    let showPaid = false; // false = show unpaid; true = show paid
    const PRICE_USD_PER_SFTR = 1.25; // fixed price for display
    function usdFor(amountStr) {
      const a = parseFloat((amountStr || "0").replace(/,/g, "").trim());
      const usd = isNaN(a) ? 0 : a * PRICE_USD_PER_SFTR;
      return `≈ $${usd.toFixed(2)}`;
    }

    function renderInvoiceList() {
      const ul = document.getElementById("invoice-list");
      const noItems = document.getElementById("no-items");
      ul.innerHTML = "";
      const source = showPaid ? PAID_INVOICES : DEMO_INVOICES;

      if (source.length === 0) {
        noItems.style.display = "block";
        return;
      } else {
        noItems.style.display = "none";
      }

      source.forEach((inv) => {
        const li = document.createElement("li");
        li.className = "rowline" + (showPaid ? "" : " clicky");
        li.innerHTML = `
          <div class="left">
            <img class="logo" src="sifter-logo.png" alt="SFTR" />
            <div>
              <div><b>${inv.amount} ${inv.symbol}</b></div>
              <div class="small">${inv.id}</div>
              ${inv.memo ? `<div class="small muted">Memo: ${inv.memo}</div>` : ""}
              ${inv.txHash ? `<div class="small txlink">Tx: <span class="kbd">${inv.txHash.slice(0,10)}…</span></div>` : ""}
            </div>
          </div>
          <div class="muted" data-usd>${usdFor(inv.amount)}</div>
        `;
        if (!showPaid) {
          li.addEventListener("click", () => selectInvoice(inv));
        }
        ul.appendChild(li);
      });
    }
    function shortAddr(a) { return a ? a.slice(0,6) + "…" + a.slice(-4) : "—"; }

    async function refreshTopbar() {
      try {
        const addr = accounts?.[0] || "";
        $("top-address").textContent = addr ? `Account: ${shortAddr(addr)}` : "Account: —";

        let balStr = "—";
        if (addr && erc20) {
          const bal = await erc20.balanceOf(addr);
          balStr = `${fmtUnits(bal)} ${CONFIG.TOKEN_SYMBOL || "SFTR"}`;
        }
        $("top-balance").textContent = `Balance: ${balStr}`;

        $("top-connect").textContent = addr ? "Connected" : "Connect Account";
      } catch (e) {
        // Non-fatal
      }
    }

    const CONFIG = {
      // Chain you expect (helps prevent mis-sends). Set null to skip enforcing.
      EXPECTED_CHAIN_ID_HEX: "0x539", // 0x539 = 1337 (Ganache). Set to null to disable.

      // Address of your payment contract that ultimately receives the ERC-20.
      PAYMENT_CONTRACT: "0x50bDa728b919D7854cdbffC94c7d2ADa188630ED",

      // The ERC-20 token contract the invoice is denominated in.
      TOKEN_CONTRACT: "0x396ee78f55f3d95442257fd14A9d60Dbe46C233d",

      // Human symbol & decimals (used for display + parsing). Decimals MUST match your token.
      TOKEN_SYMBOL: "SFTR",
      TOKEN_DECIMALS: 18,

      // Do we need an explicit approval step? (true for transferFrom-based contracts)
      REQUIRE_APPROVAL: true,

      // --- Payment contract ABI & method ---
      // Replace with your actual ABI + method. Below is a minimal example for:
      // function pay(uint256 amount, string memo) external;
      PAYMENT_ABI: [
        "function pay(uint256 amount, string memo) external",
        "event PaymentReceived(address indexed payer, uint256 amount, string memo)"
      ],

      // If your method signature differs, adapt this builder.
      // It must return: { method: string, args: any[] }
      PAY_FUNCTION_ARGS: (amountWei, memo) => ({
        method: "pay",
        args: [amountWei, memo]
      }),

      // Minimal ERC-20 ABI
      ERC20_ABI: [
        "function decimals() view returns (uint8)",
        "function symbol() view returns (string)",
        "function balanceOf(address) view returns (uint256)",
        "function allowance(address owner, address spender) view returns (uint256)",
        "function approve(address spender, uint256 amount) returns (bool)"
      ],

      // Optional block explorer base (for tx links). Example: "https://polygonscan.com/tx/"
      EXPLORER_TX_BASE: "" // leave blank if unknown
    };

    // ============
    // Helpers
    // ============
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");

    function toBytes32(str) {
      // simple hash→bytes32 if string is longer; otherwise pad
      const hex = ethers.utils.id(str || ""); // keccak256("...") -> bytes32
      return hex;
    }

    function toUnits(amountStr, decimals) {
      // tolerate commas & spaces
      const clean = (amountStr || "").replace(/,/g, "").trim();
      return ethers.utils.parseUnits(clean || "0", decimals);
    }

    function fmtUnits(bn, decimals = CONFIG.TOKEN_DECIMALS) {
      try { return ethers.utils.formatUnits(bn || 0, decimals); }
      catch { return "0"; }
    }

    function setStatus(msg) { $("status").textContent = msg || ""; }
    function setAlert(msg, ok = true) {
      const el = $("alert");
      el.textContent = msg || "";
      el.className = "notice " + (ok ? "ok" : "bad");
      if (msg) show(el); else hide(el);
    }

    function updateFiatLine() {
      const amt = $("amount").value;
      const sym = $("symbol").value || CONFIG.TOKEN_SYMBOL || "SFTR";
      $("fiatSummary").textContent = amt ? `${amt} ${sym} · ${usdFor(amt)}` : "";
    }

    // Drawer helpers
    function openDrawer() {
      $("drawer").classList.add("open");
      $("drawer-backdrop").classList.add("show");
      $("drawer-backdrop").classList.remove("hidden");
    }
    function closeDrawer() {
      $("drawer").classList.remove("open");
      $("drawer-backdrop").classList.remove("show");
      // leave element in DOM but hide for a11y
      $("drawer-backdrop").classList.add("hidden");
      // default to showing the invoice form (not result) when closing
      show($("page-invoice"));
      hide($("page-result"));
    }
    function showPage(sectionId) {
      ["page-invoice","page-confirm","page-result"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (id === sectionId) { el.classList.remove("hidden"); }
        else { el.classList.add("hidden"); }
      });
      openDrawer();
    }

    function selectInvoice(inv) {
      // Prefill the invoice form
      $("amount").value = inv.amount;
      $("symbol").value = inv.symbol;
      $("invoiceId").value = inv.id;
      $("chosen-invoice").textContent = `Selected: ${inv.id} · ${inv.amount} ${inv.symbol}`;
      selectedInvoice = inv;
      updateFiatLine();
      // Open drawer with invoice form visible
      show($("page-invoice"));
      hide($("page-result"));
      openDrawer();
    }

    // ============
    // App state
    // ============
    let provider, signer, accounts, chainId;
    let erc20, payContract;
    let selectedInvoice = null;
    let pendingPayment = null; // { amountWei, amountStr, memo }

    async function ensureProvider() {
      if (!window.ethereum) {
        throw new Error("MetaMask not found. Please install the extension.");
      }
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      return provider;
    }

    async function connect() {
      await ensureProvider();
      accounts = await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      chainId = await provider.send("eth_chainId", []);
      $("account").value = accounts[0] || "";
      if (CONFIG.EXPECTED_CHAIN_ID_HEX && chainId !== CONFIG.EXPECTED_CHAIN_ID_HEX) {
        setAlert(`Wrong network (chainId ${chainId}). Please switch to ${CONFIG.EXPECTED_CHAIN_ID_HEX}.`, false);
      } else {
        setAlert("");
      }

      erc20 = new ethers.Contract(CONFIG.TOKEN_CONTRACT, CONFIG.ERC20_ABI, signer);
      payContract = new ethers.Contract(CONFIG.PAYMENT_CONTRACT, CONFIG.PAYMENT_ABI, signer);

      // Optional sanity: try to fetch decimals/symbol
      try {
        const dec = await erc20.decimals();
        await erc20.symbol().catch(() => null); // probe, ignore value
        $("symbol").value = CONFIG.TOKEN_SYMBOL; // stick with requested display symbol
        if (dec != CONFIG.TOKEN_DECIMALS) {
          setAlert(`Warning: token decimals on-chain (${dec}) differ from CONFIG (${CONFIG.TOKEN_DECIMALS}).`, false);
        }
      } catch (e) {
        // Non-fatal if token is proxied or ABI trimmed
      }

      $("btn-pay").disabled = false;
      setStatus("Wallet connected.");
      document.body.classList.add("with-topbar");
      await refreshTopbar();
    }

    async function pay() {
      setAlert(""); setStatus("");
      $("btn-pay").disabled = true;

      try {
        if (!signer) await connect();

        const amountStr = $("amount").value;
        const amt = toUnits(amountStr, CONFIG.TOKEN_DECIMALS);
        if (amt.lte(0)) throw new Error("Amount must be greater than 0.");

        const from = await signer.getAddress();
        const invoiceIdStr = $("invoiceId").value.trim();
        const memo = invoiceIdStr || `invoice-${Date.now()}`;

        // Store for the confirm step
        pendingPayment = { amountWei: amt, amountStr, memo };

        // Confirmation summary
        $("confirm-body").innerHTML =
          `You're about to pay <b>${amountStr} ${$("symbol").value}</b> (${usdFor(amountStr)})<br>
           From <span class="kbd">${from}</span><br>
           To <span class="kbd">${CONFIG.PAYMENT_CONTRACT}</span><br>
           Memo <span class="kbd">${memo}</span>`;

        $("confirm-status").textContent = "";
        $("btn-confirm").disabled = false;

        // Show confirm page
        showPage("page-confirm");
      } catch (err) {
        console.error(err);
        const msg = err?.data?.message || err?.reason || err?.message || String(err);
        setAlert(`Error: ${msg}`, false);
        $("btn-pay").disabled = false;
      }
    }

    async function confirmAndSend() {
      try {
        $("btn-confirm").disabled = true;
        $("confirm-status").textContent = "Preparing transaction...";

        if (!pendingPayment) throw new Error("Nothing to submit. Please restart the payment.");

        const from = await signer.getAddress();
        const { amountWei, amountStr, memo } = pendingPayment;

        // Approval if required
        if (CONFIG.REQUIRE_APPROVAL) {
          $("confirm-status").textContent = "Checking allowance...";
          const currentAllowance = await erc20.allowance(from, CONFIG.PAYMENT_CONTRACT);
          if (currentAllowance.lt(amountWei)) {
            $("confirm-status").textContent = "Sending approval...";
            const txA = await erc20.approve(CONFIG.PAYMENT_CONTRACT, amountWei);
            await txA.wait();
            $("confirm-status").textContent = "Approval confirmed.";
          } else {
            $("confirm-status").textContent = "Allowance sufficient; skipping approval.";
          }
        }

        // Send payment
        const { method, args } = CONFIG.PAY_FUNCTION_ARGS(amountWei, memo);
        $("confirm-status").textContent = "Sending payment...";
        const tx = await payContract[method](...args);
        const receipt = await tx.wait();
        const txHash = receipt?.transactionHash || tx?.hash || "";

        // Transaction complete → show result
        $("result-title").textContent = "✅ Transaction Complete";
        $("result-body").innerHTML =
          `Paid <span class="kbd">${$("symbol").value}</span> <b>${amountStr}</b> (${usdFor(amountStr)}).<br>
          From <span class="kbd">${from}</span> to <span class="kbd">${CONFIG.PAYMENT_CONTRACT}</span>.<br>
          Memo <span class="kbd">${memo}</span>`;
        if (txHash && CONFIG.EXPLORER_TX_BASE) {
          $("txlink").innerHTML = `Tx: <a href="${CONFIG.EXPLORER_TX_BASE}${txHash}" target="_blank" rel="noreferrer">${txHash}</a>`;
          show($("txlink"));
        } else {
          $("txlink").innerHTML = "";
          hide($("txlink"));
        }
        showPage("page-result");

        // Remove from unpaid and add to paid
        if (selectedInvoice) {
          const idx = DEMO_INVOICES.findIndex(x => x.id === selectedInvoice.id);
          if (idx >= 0) {
            const paid = { ...DEMO_INVOICES[idx], memo, txHash };
            DEMO_INVOICES.splice(idx, 1);
            PAID_INVOICES.unshift(paid);
          }
          renderInvoiceList();
        }

        // Refresh topbar balance
        await refreshTopbar();

        // Reset pending state
        pendingPayment = null;

        // Small pause, then back to main list (show unpaid list by default)
        setTimeout(() => {
          showPaid = false;
          updateTabsUI();
          renderInvoiceList();
          closeDrawer();
          $("btn-pay").disabled = false;
          setStatus("");
          setAlert("");
        }, 1200);
      } catch (err) {
        console.error(err);
        const msg = err?.data?.message || err?.reason || err?.message || String(err);
        $("confirm-status").textContent = "";
        setAlert(`Error: ${msg}`, false);
        $("btn-confirm").disabled = false;
      }
    }
    function updateTabsUI() {
      const u = $("tab-unpaid"), p = $("tab-paid");
      if (showPaid) {
        u.classList.remove("active"); p.classList.add("active");
        $("page-list").querySelector("h1").textContent = "Paid Invoices";
        $("page-list").querySelector("h2").textContent = "Review completed payments";
      } else {
        p.classList.remove("active"); u.classList.add("active");
        $("page-list").querySelector("h1").textContent = "Invoices";
        $("page-list").querySelector("h2").textContent = "Select an invoice to pay";
      }
    }


    function switchPage(toResult, { title = "", body = "", txHash = "" } = {}) {
      if (toResult) {
        $("result-title").textContent = title || "Payment Result";
        $("result-body").innerHTML = body || "";
        const linkEl = $("txlink");
        if (txHash && CONFIG.EXPLORER_TX_BASE) {
          linkEl.innerHTML = `Tx: <a href="${CONFIG.EXPLORER_TX_BASE}${txHash}" target="_blank" rel="noreferrer">${txHash}</a>`;
          show(linkEl);
        } else {
          linkEl.innerHTML = "";
          hide(linkEl);
        }
        hide($("page-invoice"));
        show($("page-result"));
        openDrawer();
      } else {
        show($("page-invoice"));
        hide($("page-result"));
        openDrawer();
      }
    }

    // ============
    // Wire up UI
    // ============
    $("btn-connect").addEventListener("click", connect);
    $("btn-pay").addEventListener("click", pay);
    $("btn-confirm").addEventListener("click", confirmAndSend);
    $("btn-cancel").addEventListener("click", () => showPage("page-invoice"));
    $("btn-back").addEventListener("click", () => showPage("page-invoice"));
    $("btn-close").addEventListener("click", closeDrawer);
    $("drawer-backdrop").addEventListener("click", closeDrawer);
    $("amount").addEventListener("input", updateFiatLine);
    $("symbol").addEventListener("input", updateFiatLine);
    $("tab-unpaid").addEventListener("click", () => { showPaid = false; updateTabsUI(); renderInvoiceList(); });
    $("tab-paid").addEventListener("click", () => { showPaid = true; updateTabsUI(); renderInvoiceList(); });
    $("top-connect").addEventListener("click", connect);

    // Auto-connect if already authorized
    (async function autoConnectIfAuthorized() {
      if (window.ethereum) {
        try {
          const prov = await ensureProvider();
          const accs = await prov.send("eth_accounts", []);
          if (accs && accs.length) {
            await connect();
          } else {
            document.body.classList.add("with-topbar");
            await refreshTopbar();
          }
        } catch {}
      }
    })();

    renderInvoiceList();
    updateFiatLine();
    updateTabsUI();

    // Autofill from URL params (?amount=12.5&symbol=USDC&invoice=INV-1)
    (function initFromQuery() {
      const q = new URLSearchParams(location.search);
      if (q.has("amount")) $("amount").value = q.get("amount");
      if (q.has("symbol")) $("symbol").value = q.get("symbol");
      if (q.has("invoice")) $("invoiceId").value = q.get("invoice");
    })();

    // MetaMask chain/account changes
    if (window.ethereum) {
      window.ethereum.on?.("accountsChanged", () => location.reload());
      window.ethereum.on?.("chainChanged", () => location.reload());
    }
  </script>
</body>
</html>